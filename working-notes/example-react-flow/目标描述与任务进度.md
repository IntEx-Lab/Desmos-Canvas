# example-react-flow 目标描述与任务进度

> 本文档记录 example-react-flow 子项目希望实现的主要功能目标，并根据当前实现情况动态规划任务进度。
> 信息依赖指引：
> - "1. 目标功能特性"为信息源，关于子项目的需求和目标细节以此为准。与 working-notes 文件夹第一级的"项目总览.md"相关，为"项目总览.md"所提到的设计理念进行具体探索。
> - "2. 当前与目标的差距"依赖于上一节"1. 目标功能特性"，以及代码仓库中的实际情况。
> - "3. 任务进度概述"依赖于"2.当前与目标的差距"，根据当前与目标的差距动态规划任务进度，将工作分解为若干个任务，按优先级排序。
> - "4. 正在进行的任务信息"用于记录当前正在进行的某一个任务的详细信息。需要确保一个新AI助手阅读这一节后能了解到接手这个任务须知的所有背景和状态信息。

## 1. 目标功能特性

### 设计风格

- 风格定位：极简、未来感、虚像性。
- 主色调：白色为主，淡蓝/青色为辅。

- 代码节点设计：
   - 容器：无背景、无阴影、无卡片感，常态下1px透明边框，选中/编辑/hover时边缘发光。
   - 代码区：等宽字体，白色，背景透明。
   - 求值区：等宽字体，淡蓝色，极细分割线，背景透明。
   - placeholder：等宽字体，极淡蓝色。
   - 编辑态和展示态下，代码区尺寸不变。
   - 交互反馈：hover/选中/编辑时发光边缘，优先级依次提升，极简克制。
   - 节点宽度可通过左右两侧的隐形拖动区域（handle）进行调整，拖动手柄完全透明且无边框、无圆角，且在未选中时也可拖动，极简不干扰视觉。
   - NodeResizeControl需加上resizeDirection='horizontal'属性，否则react-flow对节点大小的测量会不准确，影响自定义边的计算。
   - 节点高度目前由内容自适应，后续如需支持高度拖拽或固定高度，需在节点数据结构中显式存储height，并在渲染和NodeResizeControl中传递。

### 功能特性

1. **自定义文本节点（代码片段节点）**：
   - 节点默认无背景、无边框，仅在选中/编辑/hover 时显示极细发光边缘，整体风格为极简、未来感、虚像性（白色为主，淡蓝/青色为辅）。
   - 代码区、求值区均为等宽字体。
   - 双击节点可进入编辑模式，支持多行代码输入，编辑态和展示态尺寸一致，求值区始终显示。
   - 节点本体承担主要交互区域，便于后续扩展更多功能。

2. **Floating Edge / 无锚点连接体验(参照 Excalidraw)**:
   - 取消固定连接点(handle)的显式交互，用户在"连接模式"下可直接在节点本体上按下鼠标并拖动以创建连接，无需操作具体锚点。实际上锚点变得跟节点相同大小，整个重叠并透明，整个节点都"变成了锚点"。
   - 连接线和连接点位置的计算方法应以节点间的最短路径直线为准，确保连接自然、简洁。
   - 连接线默认使用直线(Line)，后续可扩展为支持编辑为曲线（如贝塞尔曲线），但当前阶段仅需实现直线。
   - 连接线必须带有箭头，清晰指示数据流/依赖方向。
   - 这样做的优势：用户界面更简洁，操作更自然，且为后续实现 Excalidraw 式的智能连接点和用户微调功能打下基础。

3. **多模式工具栏与交互行为**:
   - 实现了模式切换工具栏，支持选择、文本和连接三种操作模式。
   - 不同模式下，画布和节点的交互行为如下：
     - **选择模式**：
       - 鼠标样式为"抓手"。
       - 双击画布空白处会立即创建一个文本/代码节点，模式不变。
       - 单击已有节点选中该节点，支持 ctrl 多选（React Flow 已原生支持 ctrl 多选，无需自定义实现）。
       - 双击已有节点进入编辑。
     - **文本模式**：
       - 鼠标样式为"十字线"。
       - 单击画布空白处创建新节点，并自动切回"选择"模式。
       - 在已有节点处，鼠标变为"编辑"样式，单击直接进入编辑。
     - **连接模式**：
       - 鼠标样式为"十字线"或"连接"指示。
       - 直接在节点本体按下鼠标并拖动到目标节点，完成连接。
   - 直观的视觉反馈，清晰指示当前活动模式。

4. **全局键盘控制与快捷键**
   - 已完成：支持惯性/缓动式WASD视野移动，V/T/C快捷键切换模式，体验流畅自然。

5. **画布状态的读写与持久化**：
   - 已实现：支持将当前画布上的所有节点、边、节点内容、节点尺寸和位置等信息序列化为 JSON，支持导出和导入。
   - 已实现：用户操作后自动保存到 localStorage，下次打开自动恢复。
   - 已实现：工具栏提供导入/导出按钮，便于用户手动操作。
   - 兼容未来节点/边类型扩展。
   - 处理版本兼容、数据校验、异常恢复等边界情况。

### 2025年5月项目目标调整

- **战略重心转移**：不再以"Para/Parasee完整技术栈探索"为首要目标，而是聚焦于"Julia+Bernard.jl+Desmos+React Flow"原型的快速落地。
- **叙事与团队建设**：优先打造一个能直观展示"画布式编程与图象创作"理念的原型，便于对外讲故事、吸引和说服新成员。
- **面向Desmos圈层**：该原型将极大提升Desmos爱好者的生产力和创作体验，让他们无需专业技能即可高效参与动画、艺术、设计等工作，也为团队吸纳Desmos背景的成员提供了实际参与和成长的路径。
- **后续可扩展性**：虽然未来Para/Parasee可能与Julia、Desmos无关，但本原型的理念和体验可迁移，是团队叙事和技术积累的重要资产。

### 2. 近期升级目标

本节补充2025年5月最新需求梳理，明确后续开发重点：

- 打造基于 Julia 的画布式编程环境，支持变量、表达式、公式对象的可视化、交互式编辑与复合，最终可导出并预览 Desmos 图像。
- 每个代码节点既是可编辑的 Julia 代码单元，也是可交互的数学对象或控件，支持变量联动、公式复用、图形化引用与自动依赖追踪。
- 后端依赖 Bernard.jl，负责表达式捕获、公式对象生成、Desmos 结构导出等核心逻辑。
- 具体任务分阶段推进，详见下文。

---

## 3. 任务进度概述

本节根据最新需求，按阶段列出主要开发任务，并注明当前状态：

### 阶段1：基础画布与节点能力升级
- [ ] 1.1 代码节点支持 Julia 语法高亮与基本编辑（可先用 contentEditable，后续可集成更强编辑器）
- [ ] 1.2 节点数据结构扩展，支持变量、表达式、公式对象等类型标记
- [ ] 1.3 节点下方控件区基础实现（滑动条、输入框、勾选框等，自动识别变量类型）
- [ ] 1.4 节点间依赖关系自动追踪与高亮显示

### 阶段2：Bernard.jl 后端集成与表达式解析
- [ ] 2.1 设计前后端 API 协议（前端传代码片段，后端返回结构化对象/控件描述/依赖信息）
- [ ] 2.2 集成 Bernard.jl，支持表达式捕获、变量/公式对象识别
- [ ] 2.3 前端根据后端返回动态渲染控件区和 Desmos 预览

### 阶段3：Desmos 预览与导出
- [ ] 3.1 节点级 Desmos 预览（内嵌或新窗口）
- [ ] 3.2 支持导出 Desmos JSON/LaTeX
- [ ] 3.3 支持批量导出/导入/分享

### 阶段4：高级交互与可扩展性
- [ ] 4.1 变量动画与控件联动
- [ ] 4.2 匿名表达式自动命名与一键重命名
- [ ] 4.3 图形化引用与依赖关系可视化
- [ ] 4.4 支持更多类型（向量、矩阵、函数等）和控件（颜色选择、下拉菜单等）

### 阶段5：画布状态持久化与版本兼容
- [ ] 5.1 画布状态自动保存/恢复
- [ ] 5.2 导入导出 JSON，带版本号
- [ ] 5.3 兼容未来节点/边/控件类型扩展

---

## 4. 正在进行的任务信息

本节用于记录当前正在进行的任务的详细信息。有时候需要新的 AI 助手来接手上一个 AI 助手负责的任务，这一节里会包括跟目前
任务相关的关键信息。



> 根据实际情况补充。
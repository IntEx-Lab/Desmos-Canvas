# example-react-flow 目标描述与任务进度

> 本文档记录 example-react-flow 子项目希望实现的主要功能目标，并根据当前实现情况动态规划任务进度。
> 信息依赖指引：
> - "1. 目标功能特性"为信息源，关于子项目的需求和目标细节以此为准。与 working-notes 文件夹第一级的"项目总览.md"相关，为"项目总览.md"所提到的设计理念进行具体探索。
> - "2. 当前与目标的差距"依赖于上一节"1. 目标功能特性"，以及代码仓库中的实际情况。
> - "3. 任务进度概述"依赖于"2.当前与目标的差距"，根据当前与目标的差距动态规划任务进度，将工作分解为若干个任务，按优先级排序。
> - "4. 正在进行的任务信息"用于记录当前正在进行的某一个任务的详细信息。需要确保一个新AI助手阅读这一节后能了解到接手这个任务须知的所有背景和状态信息。

## 1. 目标功能特性

### 设计风格

- 风格定位：极简、未来感、虚像性。
- 主色调：白色为主，淡蓝/青色为辅。

- 代码节点设计：
   - 容器：无背景、无阴影、无卡片感，常态下1px透明边框，选中/编辑/hover时边缘发光。
   - 代码区：等宽字体，白色，背景透明。
   - 求值区：等宽字体，淡蓝色，极细分割线，背景透明。
   - placeholder：等宽字体，极淡蓝色。
   - 编辑态和展示态下，代码区尺寸不变。
   - 交互反馈：hover/选中/编辑时发光边缘，优先级依次提升，极简克制。
   - 节点宽度可通过左右两侧的隐形拖动区域（handle）进行调整，拖动手柄完全透明且无边框、无圆角，且在未选中时也可拖动，极简不干扰视觉。
   - NodeResizeControl需加上resizeDirection='horizontal'属性，否则react-flow对节点大小的测量会不准确，影响自定义边的计算。
   - 节点高度目前由内容自适应，后续如需支持高度拖拽或固定高度，需在节点数据结构中显式存储height，并在渲染和NodeResizeControl中传递。

### 功能特性

1. **自定义文本节点（代码片段节点）**：
   - 节点默认无背景、无边框，仅在选中/编辑/hover 时显示极细发光边缘，整体风格为极简、未来感、虚像性（白色为主，淡蓝/青色为辅）。
   - 代码区、求值区均为等宽字体。
   - 双击节点可进入编辑模式，支持多行代码输入，编辑态和展示态尺寸一致，求值区始终显示。
   - 节点本体承担主要交互区域，便于后续扩展更多功能。

2. **Floating Edge / 无锚点连接体验(参照 Excalidraw)**:
   - 取消固定连接点(handle)的显式交互，用户在"连接模式"下可直接在节点本体上按下鼠标并拖动以创建连接，无需操作具体锚点。实际上锚点变得跟节点相同大小，整个重叠并透明，整个节点都"变成了锚点"。
   - 连接线和连接点位置的计算方法应以节点间的最短路径直线为准，确保连接自然、简洁。
   - 连接线默认使用直线(Line)，后续可扩展为支持编辑为曲线（如贝塞尔曲线），但当前阶段仅需实现直线。
   - 连接线必须带有箭头，清晰指示数据流/依赖方向。
   - 这样做的优势：用户界面更简洁，操作更自然，且为后续实现 Excalidraw 式的智能连接点和用户微调功能打下基础。

3. **多模式工具栏与交互行为**:
   - 实现了模式切换工具栏，支持选择、文本和连接三种操作模式。
   - 不同模式下，画布和节点的交互行为如下：
     - **选择模式**：
       - 鼠标样式为"抓手"。
       - 双击画布空白处会立即创建一个文本/代码节点，模式不变。
       - 单击已有节点选中该节点，支持 ctrl 多选（React Flow 已原生支持 ctrl 多选，无需自定义实现）。
       - 双击已有节点进入编辑。
     - **文本模式**：
       - 鼠标样式为"十字线"。
       - 单击画布空白处创建新节点，并自动切回"选择"模式。
       - 在已有节点处，鼠标变为"编辑"样式，单击直接进入编辑。
     - **连接模式**：
       - 鼠标样式为"十字线"或"连接"指示。
       - 直接在节点本体按下鼠标并拖动到目标节点，完成连接。
   - 直观的视觉反馈，清晰指示当前活动模式。

4. **全局键盘控制与快捷键**
   - 已完成：支持惯性/缓动式WASD视野移动，V/T/C快捷键切换模式，体验流畅自然。

5. **画布状态的读写与持久化**：
   - 已实现：支持将当前画布上的所有节点、边、节点内容、节点尺寸和位置等信息序列化为 JSON，支持导出和导入。
   - 已实现：用户操作后自动保存到 localStorage，下次打开自动恢复。
   - 已实现：工具栏提供导入/导出按钮，便于用户手动操作。
   - 兼容未来节点/边类型扩展。
   - 处理版本兼容、数据校验、异常恢复等边界情况。

6. **JavaScript执行引擎集成**：✅ **已完成（替代Julia后端）**
   - 已实现：完整的JavaScript执行引擎，支持浏览器端代码执行
   - 已实现：JavaScript控件类（Slider、InputBox、Switch）
   - 已实现：IO函数库（node_input、node_output）  
   - 已实现：console.log拦截和日志显示功能
   - 已实现：实时代码执行和结果显示
   - 已实现：节点间数据流传递
   - 已实现：错误处理和用户反馈

### 2025年5月项目目标调整 ✅ **架构重大变更**

- **执行引擎迁移**：完全移除Julia后端依赖，实现浏览器端JavaScript执行引擎
- **简化部署**：无需Julia环境，降低系统复杂度，提升访问性
- **保持功能完整性**：所有变量控件和交互功能完全保留，用户体验无变化
- **性能提升**：移除网络调用延迟，代码执行响应更快
- **技术栈统一**：前后端都使用JavaScript/TypeScript，降低开发维护成本

---

## 2. 当前实现状态分析

### 已完成的核心功能 ✅

1. **基础画布系统**
   - [x] React Flow集成和基础画布功能
   - [x] 自定义文本节点（TextNode）组件
   - [x] 自定义边（CustomEdge）组件
   - [x] 无锚点连接体验（Floating Edge）
   - [x] 节点拖拽、选择、删除等基础交互

2. **工具栏与交互模式**
   - [x] 多模式工具栏（选择/文本/连接模式）
   - [x] 工具栏模式的全局管理与自动切换
   - [x] 鼠标样式的多模式细节优化
   - [x] 全局键盘事件监听（WASD视野控制，V/T/C模式切换）

3. **JavaScript执行引擎** ✅ **新架构核心**
   - [x] 浏览器端JavaScript代码执行引擎
   - [x] console.log拦截和日志显示系统
   - [x] 执行结果实时收集和显示
   - [x] 错误处理和异常捕获
   - [x] 变量作用域管理和清理

4. **变量控件系统** ✅ **完全重构**
   - [x] JavaScript控件类（Slider、InputBox、Switch）
   - [x] IO函数库（node_input、node_output）
   - [x] 控件值双向绑定和实时更新
   - [x] 用户交互与自动执行的协调
   - [x] 右键清除控件值功能

5. **节点编辑与交互** ✅ **大幅优化**
   - [x] contentEditable编辑实现
   - [x] 编辑模式光标定位和内容保持
   - [x] 节点宽度调整功能（NodeResizeControl）
   - [x] 节点编辑区阻止拖动功能
   - [x] Code标签点击折叠/展开功能

6. **数据流与连接**
   - [x] 节点间连接和数据传递
   - [x] 边的选择和删除功能
   - [x] 连接线样式和交互优化
   - [x] 中键连接支持

7. **状态管理与持久化**
   - [x] 画布状态自动保存到localStorage
   - [x] 应用启动时状态恢复
   - [x] 导入/导出JSON功能
   - [x] 版本兼容处理

8. **UI/UX完善** ✅ **全面优化**
   - [x] 方形美学设计（移除所有圆角）
   - [x] 输入框宽度自适应优化
   - [x] 滑动条拖拽功能和React Flow事件冲突解决
   - [x] 控件样式统一和交互细节完善
   - [x] 卡片区域标签位置精确调整

### 当前的技术债务和待优化项 🔧

1. **安全性考虑**
   - JavaScript代码使用eval()直接执行，生产环境需考虑安全性
   - 建议实现代码沙箱或Web Workers隔离

2. **变量名识别改进**
   - 基于调用栈的变量名提取可以更robust
   - 考虑使用AST解析或约定命名规范

3. **性能优化空间**
   - 控件值变化的防抖可以进一步调优
   - 依赖追踪避免不必要的代码重执行
   - React组件重渲染优化

---

## 3. 任务进度概述

### 阶段1：基础画布与节点能力升级 ✅ **已完成**
- [x] 1.1 代码节点支持基本编辑功能
- [x] 1.2 节点数据结构扩展，支持变量、表达式等类型标记
- [x] 1.3 节点控件区基础实现（滑动条、输入框、开关等）
- [ ] 1.4 节点间依赖关系自动追踪与高亮显示

### 阶段2：JavaScript执行引擎实现 ✅ **已完成**
- [x] 2.1 设计JavaScript执行引擎架构
- [x] 2.2 实现浏览器端代码执行系统  
- [x] 2.3 完成console.log拦截和日志显示
- [x] 2.4 实现控件库和IO函数系统
- [x] 2.5 完成前端集成和交互优化
- [x] 2.6 Julia后端代码清理和文档更新

**阶段2成果总结：**
- ✅ 完整的JavaScript执行引擎（jsExecutor.ts）
- ✅ 类型安全的控件系统（Slider、InputBox、Switch）  
- ✅ 实时代码执行和结果显示
- ✅ console.log拦截和日志区域显示
- ✅ React Flow事件冲突解决和UI优化
- ✅ 完整的代码清理和文档更新

### 阶段3：高级交互与可扩展性 🚧 **当前重点**
- [ ] 3.1 代码语法高亮支持（JavaScript语法）
- [ ] 3.2 节点间依赖关系可视化
- [ ] 3.3 变量动画与控件联动
- [ ] 3.4 支持更多控件类型（颜色选择、下拉菜单等）

### 阶段4：数据可视化与输出 🔮 **未来计划**
- [ ] 4.1 图表输出支持（Chart.js集成）
- [ ] 4.2 Canvas绘图功能
- [ ] 4.3 数学函数可视化
- [ ] 4.4 导出功能增强（图片、SVG等）

### 阶段5：用户体验完善 🔮 **长期计划**
- [ ] 5.1 代码自动补全和智能提示
- [ ] 5.2 错误处理和用户引导改进
- [ ] 5.3 性能优化和大规模画布支持
- [ ] 5.4 移动端适配和响应式设计

---

## 4. 项目当前技术规范

### 4.1 JavaScript控件语法

**控件创建语法**：
```javascript
// 滑动条控件
let speed = node_input(new Slider(50, 0, 100, 1)); // 默认值, 最小值, 最大值, 步长

// 输入框控件  
let name = node_input(new InputBox("默认文本"));

// 开关控件
let enabled = node_input(new Switch(true)); // 默认值true/false
```

**输出语法**：
```javascript
// 直接输出变量
let result = speed * 2;
node_output(result);

// 输出复杂表达式
node_output(`${name}的速度是${speed}`);
```

**控制台输出**：
```javascript
// 所有console.log会在Logs区域显示
console.log("调试信息");
console.log("当前时间:", new Date());
```

### 4.2 节点交互规范

**编辑操作**：
- 双击Code区域进入编辑模式
- Shift+Enter或点击外部区域退出编辑
- Escape键快速退出编辑

**控件交互**：
- 滑动条：拖拽调节，点击数值设置范围
- 输入框：实时输入，自动宽度适应
- 开关：点击切换True/False状态
- 右键：所有控件支持右键重置为默认值

**区域折叠**：
- 点击"Code"标签可隐藏/显示Inputs、Logs、Outputs区域
- 便于专注代码编辑或节省空间

### 4.3 节点连接规范

**数据传递**：
- 连接的源节点输出会自动成为目标节点的输入变量
- 变量名为源节点中通过node_output()输出的变量名
- 支持多个节点连接，变量会自动合并

**连接操作**：
- 连接模式下直接在节点间拖拽创建连接
- 支持中键快速连接
- 连接线为直线样式，带箭头指示方向

---

## 5. 最近完成的重要修复 ✅

### 用户体验问题修复（2024年末）
1. **滑动条值回退问题** - 修复拖动完成后代码执行导致的值回退
2. **双重连接线问题** - 修复连接时出现的重复边显示
3. **边删除问题** - 完善边的选择和删除功能
4. **编辑模式显示问题** - 修复双击编辑后的内容显示问题
5. **光标跳转问题** - 修复编辑时光标自动跳转到末尾的问题

### 技术改进成果
- ✅ 变量值保护：executeCode函数中区分用户设置值和默认值
- ✅ 边交互改进：10px透明交互区域，选中时蓝色高亮  
- ✅ 编辑器稳定性：修复光标定位和内容同步问题
- ✅ 删除支持：完善Delete和Backspace键支持

---

## 6. 下一步重点任务

基于当前的完成情况，建议优先关注以下方向：

### 短期目标（1-2周）
1. **JavaScript语法高亮** - 提升代码编辑体验
2. **节点依赖关系可视化** - 显示数据流向和依赖关系
3. **更多控件类型** - 范围滑动条、颜色选择器等

### 中期目标（1个月）
1. **JavaScript执行引擎优化** - 处理大规模画布的性能问题
2. **用户引导** - 添加教程和帮助功能

### 长期目标（3个月）
1. **完整JavaScript集成** - 支持复杂图形的创建和导出
2. **高级交互功能** - 动画、联动等高级特性
3. **社区功能** - 分享、协作等功能

---

> 根据实际开发进度和需求变化，本文档将持续更新。
# example-react-flow 目标描述与任务进度

> 本文档记录 example-react-flow 子项目希望实现的主要功能目标，并根据当前实现情况动态规划任务进度。
> 信息依赖指引：
> - “1. 目标功能特性”为信息源，关于子项目的需求和目标细节以此为准。与 working-notes 文件夹第一级的“项目总览.md”相关，为“项目总览.md”所提到的设计理念进行具体探索。
> - “2. 当前与目标的差距”依赖于上一节“1. 目标功能特性”，以及代码仓库中的实际情况。
> - “3. 任务进度概述”依赖于“2.当前与目标的差距”，根据当前与目标的差距动态规划任务进度，将工作分解为若干个任务，按优先级排序。
> - “4. 正在进行的任务信息”用于记录当前正在进行的某一个任务的详细信息。需要确保一个新AI助手阅读这一节后能了解到接手这个任务须知的所有背景和状态信息。

## 1. 目标功能特性

1. **自定义文本节点(代码片段节点，风格参考 Exalidraw)**:
   - 节点默认无背景、无边框，仅在选中时显示边框，整体风格参考 Exalidraw。
   - 使用等宽字体(如 'Fira Mono', 'Consolas', 'Menlo', monospace)，优化代码可读性。
   - 双击节点可进入编辑模式，支持多行代码输入。
   - 节点下方有专门区域用于显示该代码片段的求值/执行结果，为代码片段提供上下文信息。
   - 节点本体承担主要交互区域，便于后续扩展更多功能。

2. **智能连接系统(无锚点连接体验，参照 Excalidraw)**:
   - 取消固定连接点(handle)的显式交互，用户在"连接模式"下可直接在节点本体上按下鼠标并拖动以创建连接，无需操作具体锚点。
   - 连接点位置由系统根据节点间的相对位置智能计算。每条边的 source/target 节点上分别为该边动态创建锚点（一边一对锚点），并在节点位置变动时实时更新锚点位置，实现真正的"无锚点"体验。
        - 需要维护好锚点的创建、删除、更新逻辑。
   - 连接线和连接点位置的计算方法应以节点间的最短路径直线为准，确保连接自然、简洁。
   - 连接线默认使用直线(Line)，后续可扩展为支持编辑为曲线（如贝塞尔曲线），但当前阶段仅需实现直线。
   - 连接线必须带有箭头，清晰指示数据流/依赖方向。React Flow 默认边无箭头，需要自定义实现。
   - 这样做的优势：用户界面更简洁，操作更自然，且为后续实现 Excalidraw 式的智能连接点和用户微调功能打下基础。

3. **多模式工具栏与交互行为**:
   - 实现了模式切换工具栏，支持选择、文本和连接三种操作模式。
   - 不同模式下，画布和节点的交互行为如下：
     - **选择模式**：
       - 鼠标样式为"抓手"。
       - 双击画布空白处会立即创建一个文本/代码节点，模式不变。
       - 单击已有节点选中该节点，支持 ctrl 多选（React Flow 已原生支持 ctrl 多选，无需自定义实现）。
       - 双击已有节点进入编辑。
     - **文本模式**：
       - 鼠标样式为"十字线"。
       - 单击画布空白处创建新节点，并自动切回"选择"模式。
       - 在画布空白处按下并拖动，可拉出一个可变宽度的文本框，松开后创建节点，并自动切回"选择"模式。
       - 在已有节点处，鼠标变为"编辑"样式，单击直接进入编辑。
     - **连接模式**：
       - 鼠标样式为"十字线"或"连接"指示。
       - 直接在节点本体按下鼠标并拖动到目标节点，完成连接。
   - 直观的视觉反馈，清晰指示当前活动模式。

---

## 2. 当前与目标的差距

本节用于记录 example-react-flow 当前实现与目标功能特性之间的差距。

- 尚未实现：
  - 文本模式下拖动拉框创建节点。
  - 文本模式下节点直接编辑等细节交互。
  - 目前创建连接的方式是先点击源节点再点击目标节点，和我们预期的"从源节点按下鼠标直接拖动一条线到目标节点"不符。
  - 目前的节点没有实现为每条边创建一个锚点，而是每个节点都统一一套 source 和 target 锚点。
  - 求值/执行结果没有采取等宽字体，影响代码可读性和一致性。
  - 双击编辑文本/代码时，节点框的大小会变动，未处于编辑状态时是一个大小，处于编辑状态时会变成另一个大小，而且编辑状态下下方的求值结果区会消失，导致用户体验不一致。

> 维护指导：请根据实际开发进展，补充未完成或有待优化的功能点。

---

## 3. 任务进度概述

本节根据当前与目标的差距，动态规划 example-react-flow 子项目的主要开发任务，按优先级排序：

1. **完善多模式下节点创建与编辑交互**
   - 目标：
     - 选择模式下支持双击空白处创建节点，文本模式下支持单击空白处创建节点并自动切回选择模式，且新建节点自动进入编辑态。
     - 文本模式下拖动拉框创建节点，单击节点直接编辑等细节交互。
   - 意义：这是画布式应用的基础能力，保证用户能自由添加内容，是后续所有交互的前提。

2. **优化连接方式为"拖动式"连接**
   - 目标：在"连接模式"下，用户可直接在节点本体按下鼠标并拖动到目标节点，完成连接，无需点击具体锚点。
   - 意义：提升交互直觉性，贴合 Excalidraw 等主流画布产品体验，为后续智能锚点和连接线优化打基础。

3. **实现每条边动态锚点机制**
   - 目标：每条边的 source/target 节点上分别为该边动态创建锚点，并在节点位置变动时实时更新，实现真正的"无锚点"体验。
   - 意义：让连接线更自然、简洁，提升整体交互和视觉体验。

4. **求值/执行结果区采用等宽字体**
   - 目标：统一节点内代码和求值区的字体为等宽字体，提升代码可读性和风格一致性。
   - 意义：优化细节体验，提升专业感和美观度。

5. **优化节点编辑时的尺寸与求值区一致性**
   - 目标：双击进入编辑模式时，节点框大小保持一致，且下方求值区不消失，保证编辑与展示状态体验一致。
   - 意义：消除编辑与展示状态的割裂感，提升用户体验。

> 以上任务建议按优先级依次推进，主流程（节点创建、连接）优先，细节体验优化可在主流程完善后统一处理。

> 维护指导：这些任务需要根据上一节"当前与目标的差距"动态规划生成。

---

## 4. 正在进行的任务信息

本节用于记录当前正在进行的任务的详细信息。有时候需要新的 AI 助手来接手上一个 AI 助手负责的任务，这一节里会包括跟目前任务相关的关键信息。

1. **完善多模式下节点创建与编辑交互**:

- 目前已完成：
  - 选择模式下双击空白处创建节点。
  - 文本模式下单击空白处创建节点并自动切回选择模式。
  - 新建节点自动进入编辑态。
  - 相关代码结构已重构，节点编辑和新建逻辑可复用。
  - 节点多选已由 React Flow 原生支持，无需自定义实现。
- 正在推进：
  - 文本模式下拖动拉框创建节点。
  - 文本模式下单击节点直接编辑等细节交互。
  - 鼠标样式、视觉反馈等细节优化。
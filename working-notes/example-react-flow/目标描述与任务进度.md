# example-react-flow 目标描述与任务进度

> 本文档记录 example-react-flow 子项目希望实现的主要功能目标，并根据当前实现情况动态规划任务进度。
> 信息依赖指引：
> - "1. 目标功能特性"为信息源，关于子项目的需求和目标细节以此为准。与 working-notes 文件夹第一级的"项目总览.md"相关，为"项目总览.md"所提到的设计理念进行具体探索。
> - "2. 当前与目标的差距"依赖于上一节"1. 目标功能特性"，以及代码仓库中的实际情况。
> - "3. 任务进度概述"依赖于"2.当前与目标的差距"，根据当前与目标的差距动态规划任务进度，将工作分解为若干个任务，按优先级排序。
> - "4. 正在进行的任务信息"用于记录当前正在进行的某一个任务的详细信息。需要确保一个新AI助手阅读这一节后能了解到接手这个任务须知的所有背景和状态信息。

## 1. 目标功能特性

### 设计风格

- 风格定位：极简、未来感、虚像性。
- 主色调：白色为主，淡蓝/青色为辅。

- 代码节点设计：
   - 容器：无背景、无阴影、无卡片感，常态下1px透明边框，选中/编辑/hover时边缘发光。
   - 代码区：等宽字体，白色，背景透明。
   - 求值区：等宽字体，淡蓝色，极细分割线，背景透明。
   - placeholder：等宽字体，极淡蓝色。
   - 编辑态和展示态下，代码区尺寸不变。
   - 交互反馈：hover/选中/编辑时发光边缘，优先级依次提升，极简克制。
   - 节点宽度可通过左右两侧的隐形拖动区域（handle）进行调整，拖动手柄完全透明且无边框、无圆角，且在未选中时也可拖动，极简不干扰视觉。
   - NodeResizeControl需加上resizeDirection='horizontal'属性，否则react-flow对节点大小的测量会不准确，影响自定义边的计算。
   - 节点高度目前由内容自适应，后续如需支持高度拖拽或固定高度，需在节点数据结构中显式存储height，并在渲染和NodeResizeControl中传递。

### 功能特性

1. **自定义文本节点（代码片段节点）**：
   - 节点默认无背景、无边框，仅在选中/编辑/hover 时显示极细发光边缘，整体风格为极简、未来感、虚像性（白色为主，淡蓝/青色为辅）。
   - 代码区、求值区均为等宽字体。
   - 双击节点可进入编辑模式，支持多行代码输入，编辑态和展示态尺寸一致，求值区始终显示。
   - 节点本体承担主要交互区域，便于后续扩展更多功能。

2. **Floating Edge / 无锚点连接体验(参照 Excalidraw)**:
   - 取消固定连接点(handle)的显式交互，用户在"连接模式"下可直接在节点本体上按下鼠标并拖动以创建连接，无需操作具体锚点。实际上锚点变得跟节点相同大小，整个重叠并透明，整个节点都"变成了锚点"。
   - 连接线和连接点位置的计算方法应以节点间的最短路径直线为准，确保连接自然、简洁。
   - 连接线默认使用直线(Line)，后续可扩展为支持编辑为曲线（如贝塞尔曲线），但当前阶段仅需实现直线。
   - 连接线必须带有箭头，清晰指示数据流/依赖方向。
   - 这样做的优势：用户界面更简洁，操作更自然，且为后续实现 Excalidraw 式的智能连接点和用户微调功能打下基础。

3. **多模式工具栏与交互行为**:
   - 实现了模式切换工具栏，支持选择、文本和连接三种操作模式。
   - 不同模式下，画布和节点的交互行为如下：
     - **选择模式**：
       - 鼠标样式为"抓手"。
       - 双击画布空白处会立即创建一个文本/代码节点，模式不变。
       - 单击已有节点选中该节点，支持 ctrl 多选（React Flow 已原生支持 ctrl 多选，无需自定义实现）。
       - 双击已有节点进入编辑。
     - **文本模式**：
       - 鼠标样式为"十字线"。
       - 单击画布空白处创建新节点，并自动切回"选择"模式。
       - 在已有节点处，鼠标变为"编辑"样式，单击直接进入编辑。
     - **连接模式**：
       - 鼠标样式为"十字线"或"连接"指示。
       - 直接在节点本体按下鼠标并拖动到目标节点，完成连接。
   - 直观的视觉反馈，清晰指示当前活动模式。

4. **全局键盘控制与快捷键**
   - 已完成：支持惯性/缓动式WASD视野移动，V/T/C快捷键切换模式，体验流畅自然。

5. **画布状态的读写与持久化**：
   - 已实现：支持将当前画布上的所有节点、边、节点内容、节点尺寸和位置等信息序列化为 JSON，支持导出和导入。
   - 已实现：用户操作后自动保存到 localStorage，下次打开自动恢复。
   - 已实现：工具栏提供导入/导出按钮，便于用户手动操作。
   - 兼容未来节点/边类型扩展。
   - 处理版本兼容、数据校验、异常恢复等边界情况。

6. **Julia后端集成与变量控件系统**：
   - 已实现：完整的Julia后端API服务器，支持代码解析和执行
   - 已实现：@input/@output标记语法，支持变量类型识别
   - 已实现：多种控件类型（滑动条、文本输入、布尔开关）
   - 已实现：实时代码执行和结果显示
   - 已实现：节点间数据流传递
   - 已实现：错误处理和用户反馈

### 2025年5月项目目标调整

- **战略重心转移**：不再以"Para/Parasee完整技术栈探索"为首要目标，而是聚焦于"Julia+Bernard.jl+Desmos+React Flow"原型的快速落地。
- **叙事与团队建设**：优先打造一个能直观展示"画布式编程与图象创作"理念的原型，便于对外讲故事、吸引和说服新成员。
- **面向Desmos圈层**：该原型将极大提升Desmos爱好者的生产力和创作体验，让他们无需专业技能即可高效参与动画、艺术、设计等工作，也为团队吸纳Desmos背景的成员提供了实际参与和成长的路径。
- **后续可扩展性**：虽然未来Para/Parasee可能与Julia、Desmos无关，但本原型的理念和体验可迁移，是团队叙事和技术积累的重要资产。

---

## 2. 当前实现状态分析

### 已完成的核心功能 ✅

1. **基础画布系统**
   - [x] React Flow集成和基础画布功能
   - [x] 自定义文本节点（TextNode）组件
   - [x] 自定义边（CustomEdge）组件
   - [x] 无锚点连接体验（Floating Edge）
   - [x] 节点拖拽、选择、删除等基础交互

2. **工具栏与交互模式**
   - [x] 多模式工具栏（选择/文本/连接模式）
   - [x] 工具栏模式的全局管理与自动切换
   - [x] 鼠标样式的多模式细节优化
   - [x] 全局键盘事件监听（WASD视野控制，V/T/C模式切换）

3. **Julia后端集成**
   - [x] Julia HTTP服务器实现
   - [x] RESTful API接口（/api/health, /api/parse, /api/evaluate）
   - [x] 代码解析和执行引擎
   - [x] 变量类型识别和控件生成
   - [x] 错误处理和日志记录

4. **变量控件系统**
   - [x] @input/@output标记语法支持
   - [x] 滑动条控件（@slidebar语法）
   - [x] 文本输入控件（@inputbox语法）
   - [x] 布尔开关控件（@boolean语法）
   - [x] 变量值双向绑定和实时更新
   - [x] 用户交互与自动执行的协调

5. **节点编辑与交互**
   - [x] contentEditable编辑实现
   - [x] 编辑模式光标定位和内容保持
   - [x] 节点宽度调整功能（NodeResizeControl）
   - [x] 节点编辑区阻止拖动功能

6. **数据流与连接**
   - [x] 节点间连接和数据传递
   - [x] 边的选择和删除功能
   - [x] 连接线样式和交互优化
   - [x] 中键连接支持

7. **状态管理与持久化**
   - [x] 画布状态自动保存到localStorage
   - [x] 应用启动时状态恢复
   - [x] 导入/导出JSON功能
   - [x] 版本兼容处理

### 当前的技术债务和待优化项 🔧

1. **用户体验改进**
   - 编辑模式下的一些显示和交互细节需要持续优化
   - 变量控件的样式和交互体验可以进一步完善
   - 错误信息的展示和用户反馈可以更友好

2. **性能优化**
   - 大量节点时的渲染性能
   - 频繁代码执行的防抖处理
   - 状态更新的优化（避免不必要的重渲染）

3. **功能扩展基础**
   - 更多变量控件类型的支持
   - 节点间依赖关系的可视化
   - 代码语法高亮功能

---

## 3. 任务进度概述

### 阶段1：基础画布与节点能力升级 ✅ **已完成**
- [x] 1.1 代码节点支持 Julia 语法高亮与基本编辑（基本编辑已完成，语法高亮待后续）
- [x] 1.2 节点数据结构扩展，支持变量、表达式、公式对象等类型标记
- [x] 1.3 节点下方控件区基础实现（滑动条、输入框、勾选框等）
- [ ] 1.4 节点间依赖关系自动追踪与高亮显示

### 阶段2：Julia后端集成与表达式解析 ✅ **已完成**
- [x] 2.1 设计前后端 API 协议（前端传代码片段，后端返回结构化对象/控件描述/依赖信息）
- [x] 2.2 集成Julia后端，支持表达式捕获、变量/公式对象识别（完整实现）
- [x] 2.3 前端根据后端返回动态渲染控件区和预览（已完成，所有测试通过）

**阶段2成果总结：**
- ✅ 完整的Julia后端API服务器（健康检查、代码解析、代码执行）
- ✅ 类型安全的变量解析系统（@input/@output标记支持）
- ✅ 前端与后端的完整集成（实时代码执行和结果显示）
- ✅ 变量控件系统（滑动条、文本输入、布尔开关）
- ✅ 错误处理和用户反馈（执行状态、错误显示）
- ✅ 中键连接支持和UI交互优化

### 阶段3：Desmos 预览与导出 🚧 **进行中**
- [ ] 3.1 节点级 Desmos 预览（内嵌或新窗口）
- [ ] 3.2 支持导出 Desmos JSON/LaTeX
- [ ] 3.3 支持批量导出/导入/分享

### 阶段4：高级交互与可扩展性 🔮 **计划中**
- [ ] 4.1 变量动画与控件联动
- [ ] 4.2 匿名表达式自动命名与一键重命名
- [ ] 4.3 图形化引用与依赖关系可视化
- [ ] 4.4 支持更多类型（向量、矩阵、函数等）和控件（颜色选择、下拉菜单等）

### 阶段5：用户体验优化与完善 🔮 **计划中**
- [ ] 5.1 Julia语法高亮支持
- [ ] 5.2 代码自动补全和智能提示
- [ ] 5.3 性能优化和大规模画布支持
- [ ] 5.4 更完善的错误处理和用户引导

---

## 4. 项目当前IO语法规范

**控件语法（在代码中声明变量控件）：**
- `@slidebar(min, max, step, defaultValue) variableName` - 滑动条控件
- `@inputbox(defaultValue) variableName` - 文本输入框
- `@boolean(defaultValue) variableName` - 布尔开关

**输出语法：**
- `@output variableName` - 标记变量为输出
- `@output alias: variableName` - 带别名的输出

**日志输出语法：**
- `@log "message"` - 输出日志信息
- `@log "prefix" * string(variable)` - 输出变量值

**输入语法：**
- 连接的节点会自动提供输入变量，无需特殊声明
- 未连接的变量会被识别为需要用户输入，可通过控件语法声明控件

**示例代码：**
```julia
@slidebar(0, 100, 1, 50) x
@slidebar(0, 100, 1, 30) y
const sum = x + y;
const product = x * y;
@log "计算结果: sum=" * string(sum)
@log "product=" * string(product)
@output sum
@output product
```

---

## 5. 最近完成的重要修复 ✅

### 用户体验问题修复（2024年末）
1. **滑动条值回退问题** - 修复拖动完成后代码执行导致的值回退
2. **双重连接线问题** - 修复连接时出现的重复边显示
3. **边删除问题** - 完善边的选择和删除功能
4. **编辑模式显示问题** - 修复双击编辑后的内容显示问题
5. **光标跳转问题** - 修复编辑时光标自动跳转到末尾的问题

### 技术改进成果
- ✅ 变量值保护：executeCode函数中区分用户设置值和默认值
- ✅ 边交互改进：10px透明交互区域，选中时蓝色高亮  
- ✅ 编辑器稳定性：修复光标定位和内容同步问题
- ✅ 删除支持：完善Delete和Backspace键支持

---

## 6. 下一步重点任务

基于当前的完成情况，建议优先关注以下方向：

### 短期目标（1-2周）
1. **Julia语法高亮** - 提升代码编辑体验
2. **节点依赖关系可视化** - 显示数据流向和依赖关系
3. **更多控件类型** - 范围滑动条、颜色选择器等

### 中期目标（1个月）
1. **Desmos预览功能** - 实现基础的Desmos图形预览
2. **性能优化** - 处理大规模画布的性能问题
3. **用户引导** - 添加教程和帮助功能

### 长期目标（3个月）
1. **完整Desmos集成** - 支持复杂图形的创建和导出
2. **高级交互功能** - 动画、联动等高级特性
3. **社区功能** - 分享、协作等功能

---

> 根据实际开发进度和需求变化，本文档将持续更新。
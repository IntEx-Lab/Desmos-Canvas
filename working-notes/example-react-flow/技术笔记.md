# example-react-flow 技术笔记

> 本文档用于记录 example-react-flow 子项目的关键技术实现、设计思路、踩坑与优化建议等。
> 如果你只是在维护本文档而没有负责其他任务，那么请不要为将要完成的任务设想解决方案。应该由负责这个任务的AI来专门思考解决方案。
> 信息依赖指引：
> - 请阅读 working-notes 文件夹中的其他文档，以便了解整个项目的背景和目标。
> - 请阅读同级的"目标描述与任务进度.md"，关于项目的目标/需求的详细描述以该文档为准。

## 目录

1. 组件设计与实现要点
2. 关键交互技术方案
   - 2.1 文本模式下拖动拉框创建节点
   - 2.2 节点的创建、编辑与聚焦
   - 2.3 连接模式新方案
   - 2.4 工具栏模式的全局管理与自动切换
   - 2.5 鼠标样式的多模式细节优化
   - 2.6 节点编辑区阻止拖动的最佳实践
   - 2.7 代码节点的contentEditable编辑实现
   - 2.8 节点宽度调整功能
   - 2.9 全局键盘事件监听与视野控制
3. 重要第三方库用法
4. 性能优化与可扩展性
5. 未来可优化点

---

## 1. 组件设计与实现要点

- 画布主组件：Canvas
- 工具栏：Toolbar
- 自定义节点：TextNode
- 自定义边：CustomEdge
- 节点与边的类型注册：在 Canvas 组件中通过 nodeTypes 和 edgeTypes 注册自定义节点和边，便于扩展。
- 节点/边的全局状态管理：主画布用 useNodesState/useEdgesState，但也有基于 Zustand 的 nodeStore 和 edgeStore，可用于更复杂的全局状态同步。

## 2. 关键交互技术方案

### 2.1 文本模式下拖动拉框创建节点

**需求简述：**
- 在"文本"模式下，用户可在画布空白处按下鼠标并拖动，拉出一个矩形区域，松开后在该区域创建一个文本/代码节点。
- 节点宽度为拉框宽度，高度始终为1行（即最小高度），并自动进入编辑态。
- 节点的 border 为 1px，padding 为 8px，代码区（contentEditable 编辑区）占据 border+padding 之内的全部空间。

**技术实现要点：**
1. 仅在 activeTool 为 'text' 时，监听画布的 onMouseDown、onMouseMove、onMouseUp。
2. 鼠标按下时记录起点，拖动时渲染一个半透明预览矩形，松开时计算拉框的宽度，创建节点，节点高度始终为1行。
3. 创建节点时，将宽度（和最小高度）通过 data 传递给 TextNode。
4. 代码节点组件支持 data 里传入 width，渲染时设置 style={{ width }}。
5. 预览矩形需在 Canvas 上层渲染，样式半透明、边框虚线。
6. 节点宽度需减去 border+padding，保证视觉与实际一致。

**注意事项：**
- 需兼容最小宽度（如 150px）和最小高度（如 40px）。

### 2.2 节点的创建、编辑与聚焦

- 支持多种节点创建方式：选择模式下双击空白处、文本模式下单击或拉框、应用初始化自动放置等。
- 通过 initialEditing 标记区分"用户手动新建代码节点"（需自动进入编辑态）和"应用初始化放置代码节点"（不进入编辑态）。
- 自动聚焦实现细节：不能直接设置 isEditing 为 true，否则 contentEditable 编辑区的 autofocus 不生效。正确做法是初始为 false，通过 useEffect 监听 initialEditing，再切换 isEditing 为 true，从而确保自动聚焦生效。

### 2.3 连接模式新方案

**背景与目标：**
- 参考 Excalidraw 的无锚点连接体验，优化连接模式的交互。
- 用户在"连接模式"下，无需精确点击锚点，直接在节点本体上按下鼠标并拖动到目标节点即可完成连接，提升连接效率和自然性。

**实现要点：**
1. **连接模式的切换与状态管理：**
   - 通过全局 activeTool 状态（Zustand store）切换到"connect"模式。
   - 工具栏按钮可切换当前模式，连接模式下鼠标样式和节点交互均有区分。

2. **节点本体即为连接区域：**
   - 每个代码节点始终渲染连接把手（handle），但仅在连接模式下显示（通过 hide-handle 类控制）。
   - 连接模式下，整个节点主体都可作为连接的起点和终点，用户体验为"无锚点"。
   - 通过 isConnectable 属性和 activeTool 状态，动态控制连接把手的可用性和可见性。

3. **连接线与自定义边：**
   - 连接线和最终的边均使用自定义实现（FloatingEdge），采用直线连接，并带有箭头。
   - 连接点的计算采用节点几何中心到中心的最短路径，并通过 getNodeIntersection 算法确保连接线自然地从节点边缘出发。
   - 连接线样式（如虚线、动画、箭头）在 CSS 和 SVG marker 中统一定义，风格极简、未来感。

4. **连接流程：**
   - 用户在连接模式下，点击某代码节点主体并拖动到另一代码节点主体，松开鼠标即创建连接。
   - 连接过程中有视觉反馈（如连接线预览）。
   - 连接完成后自动切回选择模式（如有实现）。

5. **与 React Flow 的集成：**
   - 通过 onConnect 回调处理连接事件，自动添加自定义类型的边。
   - connectionLineComponent 指定自定义连接线组件，保证连接预览与最终边一致。

**优势与体验提升：**
- 用户无需精确操作锚点，连接更自然、流畅。
- 视觉上锚点被"隐形"，界面更简洁。
- 连接线始终以最短路径连接节点边缘，避免穿透节点内容，提升美观性和可读性。
- 方案为后续实现更智能的连接点和高级交互（如多类型节点、动态锚点）打下基础。

### 2.4 工具栏模式的全局管理与自动切换

- 工具栏的当前模式（activeTool）通过 zustand 全局 store（useToolStore）管理，所有需要感知当前模式的组件均可直接读取。
- 典型交互：
  - 文本模式下，单击画布空白处或代码节点主体，完成节点创建/编辑后，自动切回选择模式。
  - 连接模式下，完成一次连接后（如连接创建成功或取消），也会切回选择模式（如有实现）。
- 这样保证了交互的直觉性，用户无需手动频繁切换模式，体验更贴近 Excalidraw 等主流画布产品。

### 2.5 鼠标样式的多模式细节优化

**需求：**
- 选择模式（select）：
  - 画布空白区为抓手（grab，React Flow 默认即可）。
  - 代码节点上方为 pointer（手指点击）。
- 文本模式（text）：
  - 画布空白区和代码节点上方都为文本光标（text），暗示可输入和编辑。

**实现要点：**
- 由于 React Flow 默认会在 `.react-flow__pane` 上强制设置 `cursor: grab`，所以不能仅靠外层 div 的 style 控制空白区的 cursor。
- 解决方法：
  1. 在 Canvas 组件最外层 div 上根据 activeTool 动态添加 `text-mode` class。
  2. 在 `Canvas/styles.css` 中增加如下样式：
     ```css
     .text-mode .react-flow__pane {
       cursor: text !important;
     }
     ```
  3. 代码节点主体（TextNode 组件）最外层 div 通过 style 动态切换 cursor：
     - select 模式下为 pointer
     - text 模式下为 text
- 这样即可实现多模式下鼠标样式的细致区分，且不会被 React Flow 默认样式覆盖。

**踩坑记录：**
- 仅在 Canvas 外层 div 上设置 cursor 无法覆盖 React Flow 画布空白区的 grab 样式，必须用更高优先级的 class 选择器和 `!important`。
- 代码节点主体的 cursor 建议直接用 style 动态切换，避免全局样式污染。

### 2.6 节点编辑区阻止拖动的最佳实践

- 在 React Flow 中，如果希望节点的某个区域（如编辑态下的 contentEditable 编辑区）不触发节点拖动，只需给该区域元素加上 `nodrag` class。
- 这样可以让用户在编辑区内自由选中、复制、编辑文本，而不会误触节点拖动或画布 pan。
- 这一点在 React Flow 的官方文档中很隐秘，藏在一个例子中，不仔细观察很难发现。
- 另外还有 `nowheel` class，可以阻止画布滚轮缩放。

### 2.7 代码节点的contentEditable编辑实现

**背景与动机**：
- 采用contentEditable 编辑区可以获得更高的自由度，实现更接近代码编辑器的体验
- 便于实现行号、语法高亮等高级功能
- 为后续扩展更丰富的代码编辑功能奠定基础

**实现关键点**：
1. 基本实现：
   - 使用带有contentEditable="true"属性的 contentEditable 编辑区作为代码编辑区
   - 处理编辑区内容的获取与设置
2. 事件处理：
   - 使用onInput事件监听内容变化
   - 处理键盘事件，如Tab键、Enter键、Shift+Enter组合键等
   - 处理粘贴事件，确保代码格式一致性
3. 光标与选择区域：
   - 使用Selection和Range API手动处理光标位置
   - 实现自动聚焦和保持编辑状态
4. 占位符效果：
   - 由于 contentEditable 编辑区没有原生 placeholder 属性，需要自行实现类似效果，如通过动态插入/移除默认文本
5. 样式一致性：
   - 确保视觉效果与代码编辑器一致
   - 保持等宽字体、行高、换行等代码显示特性

**补充说明**：
- 已实现点击进入编辑时光标定位到点击处，相关算法已抽象为 placeCaretAtPoint 工具函数。
- 为防止 React diff 导致的内容残影，编辑态和显示态的根节点加上不同的 key。

### 2.8 节点宽度调整功能

**背景与动机**：
- 固定宽度的节点无法满足不同长度代码的展示需求
- 用户需要根据代码长度和个人偏好调整节点宽度
- React Flow提供了NodeResizer组件可以实现拖动调整大小功能

**实现关键点**：
1. 基本设置：
   - 引入宽度调整控制点（NodeResizeControl）组件，分别绝对定位于代码节点左右两侧，宽度约8px，高度100%，完全透明且无边框、无圆角，仅在节点被选中时可用。
   - 配置最小/最大宽度约束
   - 设置只允许水平方向调整大小
2. 交互体验：
   - 用户可通过拖动任意一侧调整节点宽度，符合极简未来感设计要求。
   - 调整宽度调整控制点的样式，与整体设计风格一致
   - 根据选中状态控制宽度调整控制点的可见性
   - 考虑添加尺寸指示或网格对齐功能
3. 状态管理：
   - 节点大小变化需要更新到节点数据中
   - 考虑使用 onResize 相关回调来保存尺寸状态
   - 持久化节点尺寸信息，确保刷新后保持
4. 边缘处理：
   - 与连接把手（handle）的协调，确保不影响连接功能
   - 与代码节点编辑状态的协调，避免冲突
5. contentEditable 编辑区高度自适应注意事项：
   - 若节点高度为自适应（如 contentEditable 编辑区），需确保宽度调整控制点（NodeResizeControl）的高度与节点实际高度同步，避免出现拖动控制点显示不全或错位的问题。
   - 推荐在节点 data 中增加 height 字段，渲染时用 style={{height}}，并在宽度调整控制点中同步使用。
6. 其他注意事项：
   - 透明连接把手在未选中时也可拖动。
   - 宽度调整控制点需加上 resizeDirection='horizontal' 属性，否则 react-flow 对节点大小的测量会不准确，影响自定义边的计算。

### 2.9 全局键盘事件监听与视野控制

**需求简述：**
- 监听全局键盘事件，实现 wasd 控制画布平移（pan），V/T/C 快捷键切换模式。
- 保证与输入框等编辑区的键盘事件不冲突（如编辑代码时不触发 pan 或模式切换）。

**技术实现要点：**
1. 在 Canvas 组件或全局入口处监听 keydown 事件。
2. 判断事件目标，避免在 contentEditable/textarea/input 等编辑区触发快捷键。
3. wasd 控制 pan：调用 React Flow 的 `setViewport` 或 `panBy` 方法，支持按住连续移动。
4. V/T/C 切换模式：调用 zustand 的 `setActiveTool`，并触发视觉反馈（如高亮工具栏按钮）。
5. 需考虑快捷键与系统/浏览器默认行为的冲突，必要时阻止默认事件。
6. 相关状态和回调建议集中管理，便于维护和扩展。

**注意事项：**
- 编辑区聚焦时应禁用快捷键，防止影响正常输入。
- 需兼容不同操作系统的键盘布局。

## 3. 重要第三方库用法

- React Flow：节点、边、画布交互的核心库，支持自定义节点/边、拖拽、连接、缩放等。
- Zustand：虽然主流程用 React Flow 的 hooks 管理节点/边，但也有全局 store 设计，便于后续复杂状态同步。
- CSS 方案：自定义节点、边、工具栏等均有独立样式文件，部分样式通过类名动态切换（如连接模式）。

## 4. 性能优化与可扩展性

- 节点/边的唯一 id 生成：通过工具函数生成，避免重复。
- 节点/边的类型扩展：通过集中注册 nodeTypes/edgeTypes，便于后续扩展更多类型。
- 全局状态与局部状态的平衡：目前主流程用 React Flow 的 hooks，复杂场景可切换到 Zustand。

## 5. 未来可优化点

- 节点内容的自动保存与撤销/重做。
- 支持节点/边的批量操作与多选。
- 画布缩放、平移的更多自定义交互。
- 节点内容的语法高亮与代码补全。
- 支持节点高度自适应内容
- ~~支持节点宽度拖拽调整~~ (正在实现中)

> 本文件持续完善，欢迎补充。 
# example-react-flow 技术笔记

> 本文档用于记录 example-react-flow 子项目的关键技术实现、设计思路、踩坑与优化建议等。
> 如果你只是在维护本文档而没有负责其他任务，那么请不要为将要完成的任务设想解决方案。应该由负责这个任务的AI来专门思考解决方案。
> 信息依赖指引：
> - 请阅读 working-notes 文件夹中的其他文档，以便了解整个项目的背景和目标。
> - 请阅读同级的"目标描述与任务进度.md"，关于项目的目标/需求的详细描述以该文档为准。

## 目录

1. 组件设计与实现要点
2. 关键交互技术方案
   - 文本模式下拖动拉框创建节点
   - 节点的创建、编辑与聚焦
   - 连接模式
   - 工具栏模式的全局管理与自动切换
   - 鼠标样式的多模式细节优化
   - 节点编辑区阻止拖动的最佳实践
3. 重要第三方库用法
4. 性能优化与可扩展性
5. 未来可优化点

---

## 1. 组件设计与实现要点

- 画布主组件：Canvas
- 工具栏：Toolbar
- 自定义节点：TextNode
- 自定义边：CustomEdge
- 节点与边的类型注册：在 Canvas 组件中通过 nodeTypes 和 edgeTypes 注册自定义节点和边，便于扩展。
- 节点/边的全局状态管理：主画布用 useNodesState/useEdgesState，但也有基于 Zustand 的 nodeStore 和 edgeStore，可用于更复杂的全局状态同步。

## 2. 关键交互技术方案

### 2.1 文本模式下拖动拉框创建节点

**需求简述：**
- 在"文本"模式下，用户可在画布空白处按下鼠标并拖动，拉出一个矩形区域，松开后在该区域创建一个文本/代码节点。
- 节点宽度为拉框宽度，高度始终为1行（即最小高度），并自动进入编辑态。
- 节点的 border 为 1px，padding 为 8px，文本区（div/textarea）占据 border+padding 之内的全部空间。

**技术实现要点：**
1. 仅在 activeTool 为 'text' 时，监听画布的 onMouseDown、onMouseMove、onMouseUp。
2. 鼠标按下时记录起点，拖动时渲染一个半透明预览矩形，松开时计算拉框的宽度，创建节点，节点高度始终为1行。
3. 创建节点时，将宽度（和最小高度）通过 data 传递给 TextNode。
4. TextNode 组件支持 data 里传入 width，渲染时设置 style={{ width }}。
5. 预览矩形需在 Canvas 上层渲染，样式半透明、边框虚线。
6. 节点宽度需减去 border+padding，保证视觉与实际一致。

**注意事项：**
- 需兼容最小宽度（如 150px）和最小高度（如 40px）。

---

### 2.2 节点的创建、编辑与聚焦

- 支持多种节点创建方式：选择模式下双击空白处、文本模式下单击或拉框、应用初始化自动放置等。
- 通过 initialEditing 标记区分"用户手动新建节点"（需自动进入编辑态）和"应用初始化放置节点"（不进入编辑态）。
- 自动聚焦实现细节：不能直接设置 isEditing 为 true，否则 textarea 的 autofocus 不生效。正确做法是初始为 false，通过 useEffect 监听 initialEditing，再切换 isEditing 为 true，从而确保自动聚焦生效。

---

### 2.3 连接模式（connect tool）旧方案

- 当前实现为：在"连接模式"下，用户点击源节点，再点击目标节点，完成连接。
- 连接过程中有视觉指示（底部提示条）。
- 连接线为自定义边（CustomEdge），支持箭头和动画，连接点为节点左右两侧的固定 handle。
- 连接点位置暂未实现智能动态，仅为左右两侧。
- 目前尚未实现"无锚点连接"或"拖动式连接"，相关目标见任务追踪文档。

### 2.4 连接模式新方案，参考easy-connect示例

> 待补充

### 2.5 工具栏模式的全局管理与自动切换

- 工具栏的当前模式（activeTool）通过 zustand 全局 store（useToolStore）管理，所有需要感知当前模式的组件均可直接读取。
- 典型交互：
  - 文本模式下，单击画布空白处或节点本体，完成节点创建/编辑后，自动切回选择模式。
  - 连接模式下，完成一次连接后（如连接创建成功或取消），也会切回选择模式（如有实现）。
- 这样保证了交互的直觉性，用户无需手动频繁切换模式，体验更贴近 Excalidraw 等主流画布产品。

### 2.6 鼠标样式的多模式细节优化

**需求：**
- 选择模式（select）：
  - 画布空白区为抓手（grab，React Flow 默认即可）。
  - 节点上方为 pointer（手指点击）。
- 文本模式（text）：
  - 画布空白区和节点上方都为文本光标（text），暗示可输入和编辑。

**实现要点：**
- 由于 React Flow 默认会在 `.react-flow__pane` 上强制设置 `cursor: grab`，所以不能仅靠外层 div 的 style 控制空白区的 cursor。
- 解决方法：
  1. 在 Canvas 组件最外层 div 上根据 activeTool 动态添加 `text-mode` class。
  2. 在 `Canvas/styles.css` 中增加如下样式：
     ```css
     .text-mode .react-flow__pane {
       cursor: text !important;
     }
     ```
  3. 节点本体（TextNode 组件）最外层 div 通过 style 动态切换 cursor：
     - select 模式下为 pointer
     - text 模式下为 text
- 这样即可实现多模式下鼠标样式的细致区分，且不会被 React Flow 默认样式覆盖。

**踩坑记录：**
- 仅在 Canvas 外层 div 上设置 cursor 无法覆盖 React Flow 画布空白区的 grab 样式，必须用更高优先级的 class 选择器和 `!important`。
- 节点本体的 cursor 建议直接用 style 动态切换，避免全局样式污染。

### 2.7 节点编辑区阻止拖动的最佳实践

- 在 React Flow 中，如果希望节点的某个区域（如编辑态下的 textarea）不触发节点拖动，只需给该区域元素加上 `nodrag` class。
- 这样可以让用户在编辑区内自由选中、复制、编辑文本，而不会误触节点拖动或画布 pan。
- 这一点在 React Flow 的官方文档中很隐秘，藏在一个例子中，不仔细观察很难发现。
- 另外还有 `nowheel` class，可以阻止画布滚轮缩放。

## 3. 重要第三方库用法

- React Flow：节点、边、画布交互的核心库，支持自定义节点/边、拖拽、连接、缩放等。
- Zustand：虽然主流程用 React Flow 的 hooks 管理节点/边，但也有全局 store 设计，便于后续复杂状态同步。
- CSS 方案：自定义节点、边、工具栏等均有独立样式文件，部分样式通过类名动态切换（如连接模式）。

## 4. 性能优化与可扩展性

- 节点/边的唯一 id 生成：通过工具函数生成，避免重复。
- 节点/边的类型扩展：通过集中注册 nodeTypes/edgeTypes，便于后续扩展更多类型。
- 全局状态与局部状态的平衡：目前主流程用 React Flow 的 hooks，复杂场景可切换到 Zustand。

## 5. 未来可优化点

- 节点内容的自动保存与撤销/重做。
- 支持节点/边的批量操作与多选。
- 画布缩放、平移的更多自定义交互。
- 节点内容的语法高亮与代码补全。
- 支持节点高度自适应内容
- 支持节点宽度拖拽调整 

> 本文件持续完善，欢迎补充。 